<html>
<head>
  <!-- Todo list:
     - Latency display enable.
     - Support fo chinese input method, need to figure out how to deal with it
     - TextField mode
     - 

    -->
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>WiFi Keyboard</title>
  <script language="JavaScript">

   if (typeof XMLHttpRequest == "undefined")
     XMLHttpRequest = function () {
       try { return new ActiveXObject("Msxml2.XMLHTTP.6.0"); }
       catch (e) {}
       try { return new ActiveXObject("Msxml2.XMLHTTP.3.0"); }
       catch (e) {}
       try { return new ActiveXObject("Msxml2.XMLHTTP"); }
       catch (e) {}
       //Microsoft.XMLHTTP points to Msxml2.XMLHTTP.3.0 and is redundant
       throw new Error("This browser does not support XMLHttpRequest.");
   };

    // format: /seq,code,press/5012,32,1/
    ignore_next_char = false;
    repeat_key_code = "-1";

    seqConfirmed = 12345;
    seqPressed = seqConfirmed;
    events=Object();
    times=Object();
    num_inflight = 0;
    num_delayed = 0;
    latency = 0;
    latency2 = 0;
    latencyTime = 0;
    latencyTime2 = 0;
    displayState = "loading";
    stat = null;
    inp = null;
    typed_chars = 0;


    function onConfirm(newConfirmed) {
      if (newConfirmed == seqPressed) {
        events=Object();
	times=Object();
      }
      if (newConfirmed <= seqConfirmed) return;
      for (i = seqConfirmed; i < newConfirmed; i++) {
        events[i] = undefined;
	times[i] = undefined;
	seqConfirmed = newConfirmed;
      }
      network();
    }

    function queue(code, mode) {
      ev = mode + code;
      events[seqPressed] = ev;
      times[seqPressed] = new Date().getTime();
      seqPressed += 1
//      var el = document.getElementById("keys");
//      el.innerHTML = el.innerHTML + ' send:' + mode + code + " ";
    }

    function send(code, mode) {
      queue(code, mode);
      network();
    }

    function makeNotificationListener() {
      receiver = new XMLHttpRequest();
      receiver.onreadystatechange = function() {
	if (receiver.readyState != 4) return;
        if (receiver.status != 200) {
	  // FIXME: error handling
	  setTimeout("makeNotificationListener();", 2000);
	}
        if (receiver.responseText != "") {
          // debug = document.getElementById("debug");
	  // debug.innerHTML = receiver.responseText;
	}
	makeNotificationListener();
      }
      receiver.open('GET', "/listen", true);
      receiver.send(null);
    }

    function makeXhr() {
      var xhr = new XMLHttpRequest();
      xhr.newConfirmed = newConfirmed;
      xhr.reqTime = times[seqConfirmed];
      num_inflight += 1;
      xhr.onreadystatechange = function() {
	if (xhr.aborted) return;
	if (xhr.readyState != 4) return;
	num_inflight -= 1;
	xhr.finished = true;

        if (xhr.status != 200) {
	  setDisplayState("failure")
	  if (num_delayed == 0) {
	    num_delayed = 1;
            setTimeout("networkDelayed();", 2000);
	  }
	  return;
        }
        if (xhr.responseText == "problem") {
	  setDisplayState("problem");
        } else if (xhr.responseText == "multi") {
	  setDisplayState("multi");
        } else {
	  // currTime = new Date().getTime();
	  // delay = currTime - this.reqTime;
          // 
	  // if (currTime > latencyTime2 + 5000) {
	  //   latency2 = 0;
	  //   latencyTime2 = 0;
	  // }
	  // if (currTime > latencyTime + 5000) {
	  //   latency = latency2;
	  //   latencyTime = latencyTime2;
	  //   latency2 = 0;
	  //   latencyTime2 = 0;
	  // }
          //
	  // if (currTime > latencyTime + 2500) {
	  //   if (delay > latency2) {
	  //     latency2 = delay;
	  //     latencyTime2 = currTime;
	  //   }
	  // }
	  // if (delay > latency) {
	  //   latencyTime = currTime;
	  //   latency = delay;
	  // }
	  // text = "You can type now. <br>Latency is %d ms";
          // comment.innerHTML = text.replace("%d", latency);
	  setDisplayState("connected");
        }
	onConfirm(self.newConfirmed);
	network();
      }
      setTimeout(function() {
        if (xhr.finished) return;
	xhr.aborted = true;
	xhr.abort();
	num_inflight -= 1;
	setDisplayState("failure");
	makeXhr();
      }, 3000);
      xhr.open('GET', "/key?" + newConfirmed + "," + data, true);
      xhr.send(null);
      return xhr;
    }

    function network() {
      if (seqConfirmed == seqPressed) return;
      if (num_inflight > 0) return;

      //seq = seq + 1;
      //if (data.length > 200) data = data.substring(0, 200);

      charsToTransmit = seqPressed - seqConfirmed;
      if (charsToTransmit > 100) charsToTransmit = 100;
      data = events[seqConfirmed] + ",";
      newConfirmed = seqConfirmed + charsToTransmit;
      for (i = seqConfirmed + 1; i < newConfirmed; i++) {
        data = events[i] + "," + data;
      }

      var xhr = makeXhr();
    }

    function networkDelayed() {
      num_delayed = 0;
      network();
    }

    function compat() {
      return !document.f.mode[0].checked;
    }

    function is_special(code) {
      if (code <= 40) {
        if (code >= 33) return true;
	if (code == 8 || code == 9 || code == 13 || code == 27) return true;
	if (code >= 16 && code <= 20) return true;
      } else {
        if (code == 42 || code == 45 || code == 46 || code == 93 || code == 145) return true;
	if (code >= 112 && code <= 123) return true;
      }
      return false;
    }
    function keyevent(key, mode) {
      if (compat()) {
        ignore_next_char = mode == 'D';
        repeat_key_code = key;
        send(key, mode);
	return false;
      }
      if (is_special(key)) {
        ignore_next_char = mode == 'D';
        repeat_key_code = key;
        send(key, mode);
	return false;
      }
      ignore_next_char = false;
      return true;
    }

    function update_input() {
      typed_chars++;
    }

    function examine_input() {
      if (inp == null) {
        inp = document.getElementById("in");
      }
      if (inp == null) {
        typed_chars = 0;
        return;
      }
      var val = inp.value;
      if (val.length == 0) {
	typed_chars = 0;
        return;
      }

      // if not paste and not chinese
      if (val.length <= typed_chars
        && val.charCodeAt(0) < 128) {
	return;
      }
      for (i = 0; i < val.length; i++) {
        queue(val.charCodeAt(i), 'C');
      }
      typed_chars = 0;
      inp.value = "";
      network();
    }

    function up(e) {
      examine_input();
      if (!e) e = window.event;
      return keyevent(e.keyCode, 'U');
    }
    function down(e) {
      update_input();
      if (!e) e = window.event;
      return keyevent(e.keyCode, 'D');
    }
    function press(e) {
      if (ignore_next_char) {
         ignore_next_char = false;
         return false;
      }
      if (compat()) return false;
      if (!e) e = window.event;
      if (e.charCode != undefined) {
        ch = e.charCode;
      } else {
        ch = e.keyCode;
      }

      // firefox and opera hack
      if (ch == 0 || ch == repeat_key_code) {
        send(repeat_key_code, 'D');
        return false;
      }
      send(ch, 'C');
      return false;
    }
    function focus_me() {
      document.getElementById("in").focus();
    }

    function setDisplayState(newState) {
      if (newState == displayState) return;
      displayState = newState;

      if (stat == null) {
        stat = document.getElementById("status");
        comment = document.getElementById("comment");
      }
      if (stat == null) return;

      if (newState == "connected") {
        stat.innerHTML = "Connected";
        stat["color"] = "green";
        comment.innerHTML = "You can type now.";
      } else if (newState == "failure") {
        stat.innerHTML = "Connection problem";
        stat["color"] = "red";
        comment.innerHTML = "No connection between the phone and computer.";
      } else if (newState == "problem") {
        stat.innerHTML = "Not typing";
        stat["color"] = "red";
        comment.innerHTML = 'Enable WiFiKeyboard input on you device. <a href="http://code.google.com/p/wifikeyboard/wiki/WiFiKeyboardSettings">Visit help page.</a>';
      } else if (newState == "multi") {
        stat.innerHTML = "Mutiple input";
        stat["color"] = "red";
        comment.innerHTML = "Typing from multiple browser windows is not supported. Use one browser window.";
      }
    }

    function loadFinished() {
      send(1024, 'D');
    }
    window.onload = loadFinished;
</script>
<link href='http://fonts.googleapis.com/css?family=Cantal' rel='stylesheet' type='text/css'>
<link href=' http://fonts.googleapis.com/css?family=Yanone+Kaffeesatz' rel='stylesheet' type='text/css'>
<link href=' http://fonts.googleapis.com/css?family=Droid+Sans' rel='stylesheet' type='text/css'>
<link rel="icon" type="image/png" href="/icon.png" />
<style type="text/css">
   h1 {
    font-family: 'Cantal', arial, serif;
    font-size: 300%;
   } 
   h2 {
    font-family: 'Yanone Kaffeesatz', arial, serif; 
    font-size: 130%;
   }
   div {
    font-family: 'Droid Sans', arial, serif;
    font-size: 110%;
    padding: 3pt;
   }

   div.footer {
    font-family: arial, serif;
    font-size: 100%;
    text-align: right;
   }
   body {
    color:#000000;
    background-color:#f1f1ed;
    margin:0px;
    overflow:auto;
   }
   table.main {
     width:800px;
     margin-top:0px;
     margin-bottom:0px;
     background-color:#ffffff;
     padding:15px;
     background-image:url('bg.gif');
     background-repeat:repeat-x;
     height: 100%;
   }
</style>
</head>
<body id="myBody"
   onkeydown="return down(event);"
   onkeyup="return up(event);"
   onkeypress="return press(event);"
   onblur="send(1024,'D');"
   onfocus="focus_me();"
   onmouseup="setTimeout('examine_input();', 10);"
   onmouseover="setTimeout('examine_input();', 10);"
   onload="focus_me();send(1024, 'D');">
<table class="main" align="center">
<tbody>
<tr valign="top">
<td class="main" width="450">
<!-- Main Window -->
<h1>WiFi&nbsp;Keyboard</h1>
  <h2>Android input (type or paste here):
  <input id="in" type="text" value="" style="width:100%">
  </h2>

  <table border="0"><tbody><tr><td cellspacing="50" cellpadding="50">
  <form name="f">
  <h2>Keyboard mode:</h2>
  <div class="mode"><input type="radio" name="mode" value="i" checked>International keyboard</div>
  <div class="mode"><input type="radio" name="mode" value="c">Game mode (key codes only)</div>
  </form>
  </td></tr></tbody></table>
  <!-- 
  <br>
  <br>
  <form method="post" action="/form">
      <input type="hidden" name="name" value="value">
      <textarea name="text" cols="100" rows="20">
      </textarea>
      <input type="submit" value="Submit (Esc)">
  </form>-->

<!-- Main Window End -->
</td><td align="right">
<!-- Side bar -->
  <table border="1" cellpadding="20"><tbody><tr><td cellspacing="50" cellpadding="50">
  <h2>Status: <font color="black" id="status">Connecting...</font></h2>
  <div id="comment"></div>
  </td></tr></tbody></table>

  <br>
  <table border="0"><tbody><tr><td cellspacing="50" cellpadding="50">
  <h2>Special keys:</h2>
  <ul>
  <li>Shift = Shift</li>
  <li>Alt = Alt</li>
  <li>Arrows = DPAD Arrows</li>
  <li>Insert or F1 = DPAD Center</li>
  <li>F2 = Menu</li>
  <li>F3 = Search</li>
  <li>Escape = BACK</li>
  <li>F9, F10 = Volume control</li>
  </ul>
  </td></tr></tbody></table>
<!-- Side bar end -->
</td>
</tr>
<tr valign="bottom">
<td colspan="2">
  <div class="footer"><a href="http://code.google.com/p/wifikeyboard/">Source code available (license GPL v2).</a><br>Created by Ivan Volosyuk on 2010.</div>
<!-- <div id="keys">Debug: key presses:</div> -->
<!-- <div id="debug">New event placeholder.</div> -->
<td>
</tr>
</tbody>
</table>
</body>
</html>
